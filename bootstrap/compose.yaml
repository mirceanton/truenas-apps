---
configs:
  poll-config.yml:
    content: |
      - url: https://github.com/mirceanton/truenas-apps.git
        reference: main
        interval: 3600

secrets:
  1pw_token:
    file: /root/.doco-cd/1pw_token

volumes:
  data: {}

services:
  app:
    container_name: doco-cd
    image: ghcr.io/kimdre/doco-cd:0.69.0@sha256:6845c8d02b8b3dadc8e819855c843e58a0b46531143d2236b99104e76db2a5f5
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - data:/data

    secrets: ["1pw_token"]
    configs:
      - source: poll-config.yml
        target: /poll-config.yml

    environment:
      TZ: Europe/Bucharest
      LOG_LEVEL: info
      POLL_CONFIG_FILE: /poll-config.yml
      SECRET_PROVIDER: 1password
      SECRET_PROVIDER_ACCESS_TOKEN_FILE: /run/secrets/1pw_token

    healthcheck:
      test: [CMD, /doco-cd, healthcheck]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3
